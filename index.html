<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ визитов МП Belinda Lab</title>
    <style>
        :root { 
            /* Keep brand colors */
            --primary: #424B52; 
            --accent: #DF3B20; 
            --bg: #f5f5f5;

            /* Neutral UI tokens (do not change brand palette) */
            --surface: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --border: #e5e7eb;
            --border-strong: #d1d5db;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
            --shadow: 0 6px 18px rgba(0,0,0,0.08);
            --radius: 12px;
            --radius-sm: 10px;
            --focus: 0 0 0 3px rgba(223, 59, 32, 0.18);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif; 
            background: var(--bg); 
            padding: 0; 
            font-size: 13px; 
            line-height: 1.5; 
            color: var(--text);
        }
        .container { 
            max-width: 1280px; 
            margin: 0 auto; 
            padding: 20px 16px 28px; 
        }
        
        /* Header */
        .header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 14px; 
            padding: 14px 16px; 
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }
        .logo { height: 32px; }
        h1 { 
            font-size: 18px; 
            color: var(--primary); 
            font-weight: 600; 
            margin: 0;
        }
        
        /* Tabs */
        .tabs { 
            display: flex; 
            gap: 6px; 
            margin-bottom: 14px; 
            padding: 6px; 
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }
        .tab { 
            padding: 10px 14px; 
            background: transparent; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            color: var(--muted); 
            transition: all 0.2s; 
            position: relative; 
            font-size: 13px;
            border-radius: 10px;
            line-height: 1;
        }
        .tab:hover { 
            color: var(--primary); 
            background: #f3f4f6; 
        }
        .tab.active { 
            color: var(--accent); 
            background: rgba(223, 59, 32, 0.10);
        }
        .tab.active::after { content: none; }
        
        /* Content */
        .tab-content { 
            display: none; 
            animation: fadeIn 0.3s; 
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(-5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Filters */
        .filters { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 12px; 
            margin-bottom: 14px; 
            padding: 14px; 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            align-items: end;
        }
        .f-group { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
        }
        .f-group label { 
            font-size: 11px; 
            font-weight: 600; 
            color: #666; 
            text-transform: uppercase; 
        }
        select, input[type="date"], input[type="month"] { 
            height: 36px;
            padding: 0 10px; 
            border: 1px solid var(--border-strong); 
            border-radius: var(--radius-sm); 
            font-size: 13px; 
            transition: border-color 0.2s, box-shadow 0.2s; 
            width: 100%;
            background: var(--surface);
        }
        select:focus, input:focus { 
            outline: none; 
            border-color: var(--accent); 
            box-shadow: var(--focus);
        }
        button { 
            height: 36px;
            padding: 0 14px; 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 600; 
            transition: filter 0.15s, box-shadow 0.15s; 
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }
        button:hover { 
            filter: brightness(0.97); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        button:focus-visible { outline: none; box-shadow: var(--focus); }
        .btn-primary { 
            background: var(--accent); 
            color: white; 
        }
        .btn-secondary { 
            background: #95a5a6; 
            color: white; 
        }
        .btn-danger { 
            background: #e74c3c; 
            color: white; 
        }
        
        /* Tables */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 12px; 
            background: var(--surface); 
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        th { 
            background: var(--primary); 
            color: white; 
            font-weight: 600; 
            text-align: left; 
            padding: 10px 12px; 
            border: none; 
            font-size: 11px; 
        }
        th:not(:first-child) { text-align: right; }
        td { 
            padding: 8px 12px; 
            border-top: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }
        td:last-child { border-right: none; }
        td:not(:first-child) { text-align: right; }
        tr:hover { 
            background: rgba(66, 75, 82, 0.05); 
            transition: background 0.15s; 
        }
        .terr-row { 
            background: #eef0f2; 
            color: var(--primary); 
            font-weight: bold; 
        }
        .terr-row td { 
            border-top: none;
            border-right: none;
            border-bottom: 1px solid var(--border);
            padding: 10px 12px;
        }
        
        /* Calendar */
        .calendar-table { font-size: 11px; }
        .calendar-table th { 
            padding: 8px 6px; 
            text-align: right; 
            position: sticky; 
            left: 0; 
            z-index: 2; 
        }
        .calendar-table th:first-child { 
            position: sticky; 
            left: 0; 
            z-index: 3; 
            min-width: 160px; 
            text-align: left; 
        }
        .calendar-table td { 
            padding: 6px 6px; 
            text-align: right; 
        }
        .calendar-table td:first-child { 
            position: sticky; 
            left: 0; 
            background: var(--surface); 
            z-index: 1; 
            font-weight: 600; 
            text-align: left; 
            padding-left: 12px; 
        }
        .calendar-table th:first-child,
        .calendar-table td:first-child { box-shadow: 1px 0 0 var(--border); }
        .calendar-table tr:hover td:first-child { 
            background: #f0f0f0; 
        }
        .visit-count { 
            font-weight: 600; 
            color: var(--accent); 
            cursor: pointer; 
            transition: background 0.15s; 
            border-radius: 6px;
            padding: 2px 6px;
            display: inline-block;
        }
        .visit-count:hover { 
            background: rgba(223, 59, 32, 0.10) !important; 
        }
        .visit-count.zero { 
            color: #ccc; 
            font-weight: normal; 
            cursor: default; 
        }
        .weekend { background: #fff5f5 !important; }
        .stat-col { 
            background: #f8f9fa !important; 
            font-weight: 600; 
            color: var(--primary); 
        }
        .month-total { 
            background: #f8f9fa !important; 
            font-weight: 600; 
            color: var(--primary); 
        }
        
        /* Analytics */
        .clickable-number { 
            cursor: pointer; 
            font-weight: 600; 
            color: var(--accent); 
            transition: background 0.15s; 
            padding: 2px 4px; 
            border-radius: 3px; 
            display: inline-block; 
        }
        .clickable-number:hover { 
            background: rgba(223, 59, 32, 0.10); 
        }
        
        /* Loading & Empty */
        .loading, .empty { 
            text-align: center; 
            padding: 32px 16px; 
            color: var(--muted); 
        }
        .empty { 
            border: 1px dashed var(--border-strong); 
            border-radius: var(--radius); 
            background: var(--surface); 
        }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.55); 
            overflow: auto; 
            animation: fadeIn 0.2s; 
        }
        .modal-content { 
            background: var(--surface); 
            margin: 30px auto; 
            padding: 20px; 
            border-radius: var(--radius); 
            max-width: 800px; 
            max-height: 85vh; 
            overflow-y: auto; 
            animation: slideDown 0.3s; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            border-bottom: 2px solid var(--accent); 
            padding-bottom: 8px; 
        }
        .modal-header h2 {
            margin: 0;
            color: var(--primary);
            font-size: 16px;
        }
        .close-modal { 
            font-size: 24px; 
            font-weight: bold; 
            color: #aaa; 
            cursor: pointer; 
            line-height: 1; 
            transition: color 0.2s; 
            padding: 0 6px;
        }
        .close-modal:hover { 
            color: var(--primary); 
        }
        .modal-visit-item { 
            padding: 12px; 
            border: 1px solid #e0e0e0; 
            border-radius: 4px; 
            margin-bottom: 8px; 
            background: #f9f9f9; 
            transition: box-shadow 0.2s; 
        }
        .modal-visit-item:hover { 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        /* Expand icon */
        .expand-icon { 
            display: inline-block; 
            margin-right: 6px; 
            transition: transform 0.2s; 
            font-size: 10px; 
        }
        .rep-row.expanded .expand-icon { transform: rotate(90deg); }
        .rep-row { cursor: pointer; }
        .doctors-details { display: none; background: #fafafa; }
        .doctors-details.show { display: table-row; animation: fadeIn 0.2s; }
        .doctors-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .doctors-table td { 
            padding: 6px 8px; 
            border: 1px solid #ddd; 
            background: white; 
        }
        
        /* Weekend selector */
        .weekend-selector { 
            display: none; 
            margin-bottom: 16px; 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            border: 1px solid #ddd; 
        }
        .weekend-days-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 6px; 
            max-height: 150px; 
            overflow-y: auto; 
            padding: 12px; 
            background: white; 
            border-radius: 4px; 
        }
        .weekend-day-label { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            padding: 6px; 
            cursor: pointer; 
            border: 1px solid #e0e0e0; 
            border-radius: 3px; 
            font-size: 11px; 
            transition: background 0.15s; 
            background: white;
        }
        .weekend-day-label:hover { 
            background: #f0f0f0; 
        }
        
        /* Stats */
        .stats { 
            display: flex; 
            gap: 24px; 
            margin-bottom: 16px; 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            font-size: 12px; 
        }
        .stats strong { 
            color: var(--primary); 
        }
        .stats span { 
            color: var(--accent); 
            font-weight: 600; 
            font-size: 18px; 
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://belinda.tj/img/main-logo.svg" alt="Belinda" class="logo">
        <h1>Анализ визитов МП Belinda Lab</h1>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('visits')">Визиты</button>
        <button class="tab" onclick="switchTab('calendar')">Календарь визитов</button>
        <button class="tab" onclick="switchTab('analytics')">Аналитика визитов</button>
        <button class="tab" onclick="switchTab('reports')">Отчеты</button>
        <button class="tab" onclick="switchTab('planfact')">План/Факт</button>
    </div>

    <div id="tab-visits" class="tab-content active">
        <div class="filters">
            <div class="f-group">
                <label>Дата</label>
                <input type="date" id="dateFilter">
            </div>
            <div class="f-group">
                <label>МП</label>
                <select id="repFilterVisits"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Территория</label>
                <select id="terrFilterVisits"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Роль</label>
                <select id="roleFilterVisits"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Статус</label>
                <select id="statusFilterVisits"><option value="">Все</option></select>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-primary" onclick="applySelectedDate()">Принять</button>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-secondary" onclick="setTodayDate()">Сегодня</button>
            </div>
        </div>
        <div id="content" class="loading">Загрузка данных...</div>
    </div>

    <div id="tab-calendar" class="tab-content">
        <div class="filters">
            <div class="f-group">
                <label>Месяц</label>
                <input type="month" id="calendarMonth">
            </div>
            <div class="f-group">
                <label>МП</label>
                <select id="repFilterCalendar"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Территория</label>
                <select id="terrFilterCalendar"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Роль</label>
                <select id="roleFilterCalendar"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Статус</label>
                <select id="statusFilterCalendar"><option value="">Все</option></select>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-primary" onclick="setCurrentMonth()">Текущий</button>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-secondary" onclick="showWeekendSelector()">Выходные</button>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-danger" onclick="clearWeekends()">Сброс</button>
            </div>
        </div>
        <div id="weekendSelector" class="weekend-selector">
            <div style="font-weight: 600; margin-bottom: 6px; color: var(--primary); font-size: 12px;">Отметьте выходные дни:</div>
            <div id="weekendDaysList" class="weekend-days-list"></div>
            <div style="margin-top: 8px;">
                <button class="btn-primary" onclick="applyWeekends()">Применить</button>
                <button class="btn-secondary" onclick="hideWeekendSelector()" style="margin-left: 6px;">Отмена</button>
            </div>
        </div>
        <div id="calendarStats" class="stats">
            <div><strong>Рабочих дней:</strong> <span id="workdaysCount">0</span></div>
            <div><strong>Выходных дней:</strong> <span id="weekendsCount">0</span></div>
        </div>
        <div id="calendarContent" class="loading">Выберите месяц</div>
    </div>

    <div id="tab-analytics" class="tab-content">
        <div class="filters">
            <div class="f-group">
                <label>Месяц</label>
                <input type="month" id="analyticsMonth">
            </div>
            <div class="f-group">
                <label>МП</label>
                <select id="repFilterAnalytics"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Территория</label>
                <select id="terrFilterAnalytics"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Роль</label>
                <select id="roleFilterAnalytics"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Статус</label>
                <select id="statusFilterAnalytics"><option value="">Все</option></select>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-primary" onclick="setCurrentMonthAnalytics()">Текущий</button>
            </div>
        </div>
        <div id="analyticsContent" class="loading">Выберите месяц</div>
    </div>

    <div id="tab-reports" class="tab-content">
        <div class="filters">
            <div class="f-group">
                <label>Месяц</label>
                <input type="month" id="reportsMonth">
            </div>
            <div class="f-group">
                <label>МП</label>
                <select id="repFilterReports"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Территория</label>
                <select id="terrFilterReports"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Роль</label>
                <select id="roleFilterReports"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Статус</label>
                <select id="statusFilterReports"><option value="">Все</option></select>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-primary" onclick="setCurrentMonthReports()">Текущий</button>
            </div>
        </div>
        <div id="reportsContent" class="loading">Выберите месяц</div>
    </div>

    <div id="tab-planfact" class="tab-content">
        <div class="filters">
            <div class="f-group">
                <label>Месяц</label>
                <input type="month" id="planfactMonth">
            </div>
            <div class="f-group">
                <label>МП</label>
                <select id="repFilterPlanFact"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Территория</label>
                <select id="terrFilterPlanFact"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Роль</label>
                <select id="roleFilterPlanFact"><option value="">Все</option></select>
            </div>
            <div class="f-group">
                <label>Статус</label>
                <select id="statusFilterPlanFact"><option value="">Все</option></select>
            </div>
            <div class="f-group" style="align-items: center;">
                <button class="btn-primary" onclick="setCurrentMonthPlanFact()">Текущий</button>
            </div>
        </div>
        <div id="planfactContent" class="loading">Выберите месяц</div>
    </div>
</div>

<!-- Modal -->
<div id="visitsModal" class="modal" onclick="if(event.target.id === 'visitsModal') closeVisitsModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modalTitle" style="margin: 0; color: var(--primary); font-size: 16px;">Детали визитов</h2>
            <span class="close-modal" onclick="closeVisitsModal()">&times;</span>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyw_tHQcmaozlrrHJBpKxpHrx70KaK0_pKiB1B9Riws_qJmFytlw_bJBNNPKAjjUBHKTw/exec";
    
    let rawData = [];
    let employeesData = [];
    let allEmployeesData = [];
    let selectedWeekends = new Set();
    let autoDetectedMonth = null;
    let reportsDataCache = { monthData: [], lpuVisits: {}, specialistVisits: {} };

    const today = new Date();
    const dateFilterEl = document.getElementById('dateFilter');
    if (dateFilterEl) dateFilterEl.value = today.toISOString().split('T')[0];
    
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const monthValue = `${year}-${month}`;
    const calendarMonthEl = document.getElementById('calendarMonth');
    if (calendarMonthEl) calendarMonthEl.value = monthValue;
    const analyticsMonthEl = document.getElementById('analyticsMonth');
    if (analyticsMonthEl) analyticsMonthEl.value = monthValue;
    const reportsMonthEl = document.getElementById('reportsMonth');
    if (reportsMonthEl) reportsMonthEl.value = monthValue;
    const planfactMonthEl = document.getElementById('planfactMonth');
    if (planfactMonthEl) planfactMonthEl.value = monthValue;

    async function fetchData() {
        const container = document.getElementById('content');
        container.innerHTML = '<div class="loading">Загрузка данных...</div>';
        try {
            const response = await fetch(API_URL);
            const result = await response.json();
            
            // Обрабатываем новый формат данных
            if (result.visits && result.employees) {
                rawData = result.visits || [];
                employeesData = result.employees || []; // Активные МП для фильтрации визитов
                allEmployeesData = result.allEmployees || result.employees || []; // Все сотрудники для отображения
                
                // Если allEmployeesData пустой, используем employeesData
                if (allEmployeesData.length === 0 && employeesData.length > 0) {
                    allEmployeesData = employeesData;
                }
            } else if (Array.isArray(result)) {
                // Старый формат (только массив визитов) - для обратной совместимости
                rawData = result;
                employeesData = [];
                allEmployeesData = [];
            } else {
                throw new Error(result.error || 'Неверный формат данных');
            }
            
            console.log('Загружено:', {
                visits: rawData.length,
                activeEmployees: employeesData.length,
                allEmployees: allEmployeesData.length,
                resultKeys: Object.keys(result)
            });
            
            // Если allEmployeesData пустой, но есть employeesData, используем его
            if ((!allEmployeesData || allEmployeesData.length === 0) && employeesData && employeesData.length > 0) {
                allEmployeesData = employeesData;
                console.log('Используем employeesData как allEmployeesData');
            }
            
            // Фильтруем визиты только по активным сотрудникам с ролью "МП"
            // (скрипт уже отфильтровал по статусу "Активный" и роли "МП")
            if (employeesData.length > 0) {
                const activeReps = new Set();
                employeesData.forEach(emp => {
                    // Пробуем разные варианты названий колонки с именем МП
                    // Скрипт уже добавил имя в поле "МП", если колонка была без заголовка
                    const name = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                                 emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                    if (name && name.toString().trim()) {
                        activeReps.add(name.toString().trim());
                    }
                });
                
                rawData = rawData.filter(visit => {
                    const repName = visit["Мед представитель"] || visit["Мед. представитель"] || 
                                   visit["мед представитель"] || visit["Медицинский представитель"] || "";
                    return activeReps.has(repName.toString().trim());
                });
            }
            
            fillFilters();
            renderData();
        } catch (e) {
            console.error('Ошибка загрузки данных:', e);
            container.innerHTML = `<div class="empty" style="color: red;">Ошибка загрузки данных: ${e.message}<br><small>Проверьте консоль браузера (F12) для подробностей</small></div>`;
        }
    }

    function fillFilters() {
        // Используем ТОЛЬКО актуальные данные сотрудников из листа "Сотрудники"
        let reps = [];
        let terrs = [];
        let roles = [];
        let statuses = [];
        
        // Используем только allEmployeesData (актуальный список всех сотрудников)
        const sourceData = (allEmployeesData && allEmployeesData.length > 0) ? allEmployeesData : [];
        
        if (sourceData.length > 0) {
            // Берем данные ТОЛЬКО из листа сотрудников (актуальный список)
            reps = [...new Set(sourceData.map(emp => {
                const name = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                            emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                return name.toString().trim();
            }))].filter(Boolean).sort();
            
            terrs = [...new Set(sourceData.map(emp => {
                const terr = emp["Область"] || emp["Область "] || emp["область"] || 
                            emp["Территория"] || emp["Территория "] || emp["территория"] || "";
                return terr.toString().trim();
            }))].filter(Boolean).sort();
            
            roles = [...new Set(sourceData.map(emp => {
                const role = emp["Роль"] || emp["роль"] || emp["Роль "] || "";
                return role.toString().trim();
            }))].filter(Boolean).sort();
            
            statuses = [...new Set(sourceData.map(emp => {
                const status = emp["Статус"] || emp["статус"] || emp["Статус "] || "";
                return status.toString().trim();
            }))].filter(Boolean).sort();
        }
        
        console.log('Заполнение фильтров из списка сотрудников:', { reps: reps.length, terrs: terrs.length, roles: roles.length, statuses: statuses.length });
        
        ['repFilterVisits', 'repFilterCalendar', 'repFilterAnalytics', 'repFilterReports', 'repFilterPlanFact'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Все</option>';
                reps.forEach(r => select.innerHTML += `<option value="${r}">${r}</option>`);
            }
        });
        
        ['terrFilterVisits', 'terrFilterCalendar', 'terrFilterAnalytics', 'terrFilterReports', 'terrFilterPlanFact'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Все</option>';
                terrs.forEach(t => select.innerHTML += `<option value="${t}">${t}</option>`);
            }
        });
        
        ['roleFilterVisits', 'roleFilterCalendar', 'roleFilterAnalytics', 'roleFilterReports', 'roleFilterPlanFact'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Все</option>';
                roles.forEach(r => select.innerHTML += `<option value="${r}">${r}</option>`);
            }
        });
        
        ['statusFilterVisits', 'statusFilterCalendar', 'statusFilterAnalytics', 'statusFilterReports', 'statusFilterPlanFact'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '<option value="">Все</option>';
                statuses.forEach(s => select.innerHTML += `<option value="${s}">${s}</option>`);
            }
        });
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        
        document.querySelectorAll('.tab').forEach(btn => {
            if ((tabName === 'visits' && btn.textContent.trim() === 'Визиты') ||
                (tabName === 'calendar' && btn.textContent.trim() === 'Календарь визитов') ||
                (tabName === 'analytics' && btn.textContent.trim() === 'Аналитика визитов') ||
                (tabName === 'reports' && btn.textContent.trim() === 'Отчеты') ||
                (tabName === 'planfact' && btn.textContent.trim() === 'План/Факт')) {
                btn.classList.add('active');
            }
        });
        
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        if (tabName === 'calendar') {
            const monthInputEl = document.getElementById('calendarMonth');
            if (!monthInputEl) return;
            const monthInput = monthInputEl.value;
            if (!monthInput) setCurrentMonth();
            else { autoDetectWeekends(monthInput, false); renderCalendar(); }
        } else if (tabName === 'analytics') {
            const monthInputEl = document.getElementById('analyticsMonth');
            if (!monthInputEl) {
                console.error('analyticsMonth не найден');
                return;
            }
            const monthInput = monthInputEl.value;
            if (!monthInput) {
                setCurrentMonthAnalytics();
            } else {
                // Вызываем сразу, без задержки
                renderAnalytics();
            }
        } else if (tabName === 'reports') {
            const monthInputEl = document.getElementById('reportsMonth');
            if (!monthInputEl) return;
            const monthInput = monthInputEl.value;
            if (!monthInput) setCurrentMonthReports();
            else renderReports();
        } else if (tabName === 'planfact') {
            const monthInputEl = document.getElementById('planfactMonth');
            if (!monthInputEl) return;
            const monthInput = monthInputEl.value;
            if (!monthInput) setCurrentMonthPlanFact();
            else renderPlanFact();
        }
    }

    function setTodayDate() {
        const dateFilterEl = document.getElementById('dateFilter');
        if (dateFilterEl) dateFilterEl.value = today.toISOString().split('T')[0];
        applySelectedDate();
    }

    function applySelectedDate() {
        const dateFilterEl = document.getElementById('dateFilter');
        if (dateFilterEl && !dateFilterEl.value) dateFilterEl.value = today.toISOString().split('T')[0];
        renderData();
    }

    function renderData() {
        const container = document.getElementById('content');
        if (!container) return;
        const dateFilterEl = document.getElementById('dateFilter');
        const repFilterEl = document.getElementById('repFilterVisits');
        const terrFilterEl = document.getElementById('terrFilterVisits');
        const roleFilterEl = document.getElementById('roleFilterVisits');
        const statusFilterEl = document.getElementById('statusFilterVisits');
        if (!dateFilterEl || !repFilterEl || !terrFilterEl) return;
        const fDate = dateFilterEl.value;
        const fRep = repFilterEl.value;
        const fTerr = terrFilterEl.value;
        const fRole = roleFilterEl?.value || "";
        const fStatus = statusFilterEl?.value || "";

        // Создаем карту сотрудников из актуальных данных сотрудников
        const employeesMap = {};
        const empSourceData = (allEmployeesData && allEmployeesData.length > 0) ? allEmployeesData : 
                             (employeesData && employeesData.length > 0) ? employeesData : [];
        if (empSourceData.length > 0) {
            empSourceData.forEach(emp => {
                const repName = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                               emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (repName) {
                    employeesMap[repName.toString().trim()] = {
                        territory: emp["Область"] || emp["Область "] || emp["область"] || 
                                   emp["Территория"] || emp["Территория "] || emp["территория"] || "Прочие",
                        group: emp["Группа"] || emp["Группа "] || emp["группа"] || "-"
                    };
                }
            });
        }
        
        // Создаем список ТОЛЬКО из актуального списка сотрудников
        const allRepsMap = {};
        const empListData = (allEmployeesData && allEmployeesData.length > 0) ? allEmployeesData : [];
        
        // Добавляем ТОЛЬКО сотрудников из актуального списка
        if (empListData.length > 0) {
            empListData.forEach(emp => {
                const rep = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                           emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (!rep) return;
                
                const role = emp["Роль"] || emp["роль"] || emp["Роль "] || "";
                const status = emp["Статус"] || emp["статус"] || emp["Статус "] || "";
                
                // Фильтруем по роли и статусу
                if (fRole && role.toString().trim() !== fRole) return;
                if (fStatus && status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim()) return;
                
                const empInfo = employeesMap[rep.toString().trim()];
                const terr = empInfo ? empInfo.territory : (emp["Область"] || emp["Область "] || emp["область"] || 
                           emp["Территория"] || emp["Территория "] || emp["территория"] || "Прочие");
                const group = empInfo ? empInfo.group : (emp["Группа"] || emp["Группа "] || emp["группа"] || "-");
                
                const key = `${terr}|${rep}`;
                if (!allRepsMap[key]) {
                    allRepsMap[key] = { rep: rep, territory: terr, group: group, hasVisitsToday: false };
                }
            });
        }

        // Создаем список актуальных МП из списка сотрудников для фильтрации
        const validReps = new Set();
        if (empListData.length > 0) {
            empListData.forEach(emp => {
                const name = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                            emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (name) validReps.add(name.toString().trim());
            });
        }
        
        // Создаем список актуальных территорий из списка сотрудников
        const validTerrs = new Set();
        if (empListData.length > 0) {
            empListData.forEach(emp => {
                const terr = emp["Область"] || emp["Область "] || emp["область"] || 
                            emp["Территория"] || emp["Территория "] || emp["территория"] || "";
                if (terr) validTerrs.add(terr.toString().trim());
            });
        }
        
        const filtered = rawData.filter(row => {
            const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "];
            const repName = row["Мед представитель"] || row["Мед. представитель"] || 
                          row["мед представитель"] || row["Медицинский представитель"] || "";
            const rowTerr = row["Территория"] || row["территория"] || "";
            
            // Фильтруем только визиты от актуальных МП
            if (validReps.size > 0 && !validReps.has(repName.toString().trim())) return false;
            
            // Фильтруем по дате и выбранным фильтрам
            return rowDate === fDate && 
                   (!fRep || repName === fRep) && 
                   (!fTerr || (validTerrs.size > 0 ? validTerrs.has(rowTerr.toString().trim()) : rowTerr === fTerr));
        });

        // Создаем список актуальных МП для проверки
        const validRepsSet = new Set();
        if (empListData.length > 0) {
            empListData.forEach(emp => {
                const rep = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                           emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (rep) validRepsSet.add(rep.toString().trim());
            });
        }
        
        // Создаем карту ролей и статусов для проверки фильтров
        const employeesRoleStatusForVisits = {};
        if (empListData.length > 0) {
            empListData.forEach(emp => {
                const rep = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                           emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (rep) {
                    employeesRoleStatusForVisits[rep.toString().trim()] = {
                        role: emp["Роль"] || emp["роль"] || emp["Роль "] || "",
                        status: emp["Статус"] || emp["статус"] || emp["Статус "] || ""
                    };
                }
            });
        }
        
        const report = {};
        filtered.forEach(row => {
            const m = row["Мед представитель"] || "";
            // Пропускаем визиты от сотрудников, которых нет в актуальном списке
            if (!validRepsSet.has(m.toString().trim())) return;
            
            // Фильтруем по роли и статусу
            const empRoleStatus = employeesRoleStatusForVisits[m.toString().trim()];
            if (fRole && (!empRoleStatus || empRoleStatus.role.toString().trim() !== fRole)) return;
            if (fStatus && (!empRoleStatus || empRoleStatus.status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim())) return;
            
            const empInfo = employeesMap[m.toString().trim()];
            const t = empInfo ? empInfo.territory : "Прочие";
            const group = empInfo ? empInfo.group : "-";
            const key = `${t}|${m}`;
            if (allRepsMap[key]) allRepsMap[key].hasVisitsToday = true;
            if (!report[t]) report[t] = {};
            if (!report[t][m]) {
                report[t][m] = { lpus: new Set(), docs: new Set(), doctorsList: [], group: group };
            }
            if (row["Аб ЛПУ"]) report[t][m].lpus.add(row["Аб ЛПУ"]);
            if (row["Имя доктора"]) {
                report[t][m].docs.add(row["Имя доктора"]);
                report[t][m].doctorsList.push({
                    doctor: row["Имя доктора"],
                    lpuAbbr: row["Аб ЛПУ"] || row["Аб лпу"] || row["АБ ЛПУ"] || "-",
                    lpuFull: row["ЛПУ"] || row["Название ЛПУ"] || row["Лпу"] || "-",
                    spec: row["Специальность"] || row["Специальность врача"] || row["специальность"] || "-"
                });
            }
        });

        Object.values(allRepsMap).forEach(repInfo => {
            // Проверяем фильтры по роли и статусу
            const empRoleStatus = employeesRoleStatusForVisits[repInfo.rep.toString().trim()];
            if (fRole && (!empRoleStatus || empRoleStatus.role.toString().trim() !== fRole)) return;
            if (fStatus && (!empRoleStatus || empRoleStatus.status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim())) return;
            
            if ((fRep && repInfo.rep !== fRep) || (fTerr && repInfo.territory !== fTerr)) return;
            if (!repInfo.hasVisitsToday) {
                const t = repInfo.territory;
                const m = repInfo.rep;
                if (!report[t]) report[t] = {};
                if (!report[t][m]) {
                    report[t][m] = { lpus: new Set(), docs: new Set(), doctorsList: [], group: repInfo.group, notFilled: true };
                }
            }
        });

        function getGroupSortOrder(group) {
            const g = (group || "").toLowerCase();
            if (g.includes("альфа")) return 1;
            if (g.includes("бета")) return 2;
            if (g.includes("гамма") || g.includes("gamma")) return 3;
            if (g.includes("дельта") || g.includes("delta")) return 4;
            return 999;
        }

        function sortReps(terr) {
            return Object.keys(report[terr]).sort((a, b) => {
                const orderA = getGroupSortOrder(report[terr][a].group);
                const orderB = getGroupSortOrder(report[terr][b].group);
                return orderA !== orderB ? orderA - orderB : a.localeCompare(b);
            });
        }

        let html = '<table><thead><tr><th>Представитель</th><th>Группа</th><th>ЛПУ</th><th>Врачи</th><th>Статус</th></tr></thead><tbody>';
        
        Object.keys(report).sort().forEach(terr => {
            html += `<tr class="terr-row"><td colspan="5">${terr}</td></tr>`;
            sortReps(terr).forEach((rep, idx) => {
                const d = report[terr][rep];
                const status = d.notFilled ? '<span style="color: #DF3B20; font-weight: bold;">❌</span>' : '<span style="color: #2ecc71;">✓</span>';
                const rowId = `rep-${terr}-${rep}-${idx}`.replace(/\s+/g, '-');
                const hasDoctors = d.doctorsList && d.doctorsList.length > 0;
                
                html += `<tr class="rep-row ${hasDoctors ? '' : ''}" ${hasDoctors ? `onclick="toggleDoctors('${rowId}')"` : ''} ${d.notFilled ? 'style="background: #fff5f5;"' : ''} id="${rowId}">
                    <td style="padding-left: 8px; text-align: left;">${hasDoctors ? '<span class="expand-icon">▶</span>' : ''}${rep}</td>
                    <td style="text-align: right;">${d.group}</td>
                    <td style="text-align: right;"><b>${d.lpus.size}</b></td>
                    <td style="text-align: right;"><b>${d.docs.size}</b></td>
                    <td style="text-align: right;">${status}</td>
                </tr>`;
                
                if (hasDoctors) {
                    const sortedDoctors = [...d.doctorsList].sort((a, b) => (a.lpuFull || a.lpuAbbr || '').localeCompare(b.lpuFull || b.lpuAbbr || '', 'ru'));
                    let doctorsHtml = '<td colspan="5" style="text-align: left;"><div style="padding: 4px 8px;"><table class="doctors-table">';
                    sortedDoctors.forEach(doc => {
                        doctorsHtml += `<tr><td style="width: 30%; text-align: left;">${doc.lpuFull !== '-' ? doc.lpuFull : '-'}</td><td style="width: 15%; text-align: left;">${doc.lpuAbbr !== '-' && doc.lpuAbbr !== doc.lpuFull ? doc.lpuAbbr : '-'}</td><td style="width: 35%; text-align: left;">${doc.doctor || '-'}</td><td style="width: 20%; text-align: left;">${doc.spec !== '-' ? doc.spec : '-'}</td></tr>`;
                    });
                    doctorsHtml += '</table></div></td>';
                    html += `<tr class="doctors-details" id="${rowId}-details">${doctorsHtml}</tr>`;
                }
            });
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function toggleDoctors(rowId) {
        const row = document.getElementById(rowId);
        const details = document.getElementById(rowId + '-details');
        if (details) {
            details.classList.toggle('show');
            row.classList.toggle('expanded');
        }
    }

    function setCurrentMonth() {
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const monthValue = `${year}-${month}`;
        const calendarMonthEl = document.getElementById('calendarMonth');
        if (calendarMonthEl) calendarMonthEl.value = monthValue;
        autoDetectedMonth = null;
        autoDetectWeekends(monthValue, true);
        renderCalendar();
    }

    function setCurrentMonthAnalytics() {
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const monthValue = `${year}-${month}`;
        const analyticsMonthEl = document.getElementById('analyticsMonth');
        if (analyticsMonthEl) analyticsMonthEl.value = monthValue;
        renderAnalytics();
    }

    function isWeekend(date) {
        return selectedWeekends.has(date.toISOString().split('T')[0]);
    }

    function autoDetectWeekends(monthInput, force) {
        if (!monthInput || (!force && autoDetectedMonth === monthInput)) return;
        const [year, month] = monthInput.split('-').map(Number);
        const monthStart = new Date(year, month - 1, 1).toISOString().split('T')[0];
        const monthEnd = new Date(year, month, 0).toISOString().split('T')[0];
        Array.from(selectedWeekends).forEach(dateStr => {
            if (dateStr >= monthStart && dateStr <= monthEnd) selectedWeekends.delete(dateStr);
        });
        const lastDay = new Date(year, month, 0);
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0 || (dayOfWeek === 6 && Math.ceil(day / 7) % 2 === 0)) {
                selectedWeekends.add(date.toISOString().split('T')[0]);
            }
        }
        autoDetectedMonth = monthInput;
    }

    function showWeekendSelector() {
        const selector = document.getElementById('weekendSelector');
        const monthInputEl = document.getElementById('calendarMonth');
        if (!selector || !monthInputEl) return;
        const monthInput = monthInputEl.value;
        if (!monthInput) { alert('Сначала выберите месяц'); return; }
        autoDetectWeekends(monthInput, false);
        const [year, month] = monthInput.split('-').map(Number);
        const lastDay = new Date(year, month, 0);
        let html = '';
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month - 1, day);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][date.getDay()];
            const dateLabel = `${day}.${String(month).padStart(2, '0')} (${dayName})`;
            const checked = selectedWeekends.has(dateStr);
            html += `<label class="weekend-day-label" style="background: ${checked ? '#fff5f5' : 'white'};"><input type="checkbox" value="${dateStr}" ${checked ? 'checked' : ''} onchange="toggleWeekendDay('${dateStr}')"><span>${dateLabel}</span></label>`;
        }
        document.getElementById('weekendDaysList').innerHTML = html;
        selector.style.display = 'block';
    }

    function hideWeekendSelector() {
        document.getElementById('weekendSelector').style.display = 'none';
    }

    function toggleWeekendDay(dateStr) {
        if (selectedWeekends.has(dateStr)) selectedWeekends.delete(dateStr);
        else selectedWeekends.add(dateStr);
        const checkbox = document.querySelector(`input[value="${dateStr}"]`);
        const label = checkbox ? checkbox.closest('label') : null;
        if (checkbox && label) {
            checkbox.checked = selectedWeekends.has(dateStr);
            label.style.background = selectedWeekends.has(dateStr) ? '#fff5f5' : 'white';
        }
    }

    function applyWeekends() {
        hideWeekendSelector();
        renderCalendar();
    }

    function clearWeekends() {
        const monthInputEl = document.getElementById('calendarMonth');
        if (!monthInputEl) return;
        const monthInput = monthInputEl.value;
        if (monthInput) {
            const [year, month] = monthInput.split('-').map(Number);
            const monthStart = new Date(year, month - 1, 1).toISOString().split('T')[0];
            const monthEnd = new Date(year, month, 0).toISOString().split('T')[0];
            Array.from(selectedWeekends).forEach(dateStr => {
                if (dateStr >= monthStart && dateStr <= monthEnd) selectedWeekends.delete(dateStr);
            });
            autoDetectedMonth = null;
        }
        hideWeekendSelector();
        renderCalendar();
    }

    function renderCalendar() {
        const container = document.getElementById('calendarContent');
        const monthInputEl = document.getElementById('calendarMonth');
        if (!monthInputEl) return;
        const monthInput = monthInputEl.value;
        if (!monthInput || !rawData || rawData.length === 0) {
            if (container) container.innerHTML = '<div class="empty">Загрузите данные и выберите месяц</div>';
            return;
        }
        autoDetectWeekends(monthInput, false);
        const [year, month] = monthInput.split('-').map(Number);
        const lastDay = new Date(year, month, 0);
        const allDays = [];
        for (let day = 1; day <= lastDay.getDate(); day++) allDays.push(new Date(year, month - 1, day));
        const daysToShow = allDays.filter(date => !isWeekend(date));
        const workdaysCountEl = document.getElementById('workdaysCount');
        const weekendsCountEl = document.getElementById('weekendsCount');
        if (workdaysCountEl) workdaysCountEl.textContent = daysToShow.length;
        if (weekendsCountEl) weekendsCountEl.textContent = allDays.length - daysToShow.length;
        // Создаем карту сотрудников из актуальных данных
        const employeesMap = {};
        const empMapData = (allEmployeesData && allEmployeesData.length > 0) ? allEmployeesData : 
                          (employeesData && employeesData.length > 0) ? employeesData : [];
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const repName = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                               emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (repName) {
                    employeesMap[repName.toString().trim()] = {
                        territory: emp["Область"] || emp["Область "] || emp["область"] || 
                                   emp["Территория"] || emp["Территория "] || emp["территория"] || "Прочие",
                        group: emp["Группа"] || emp["Группа "] || emp["группа"] || "-"
                    };
                }
            });
        }
        
        const fRep = document.getElementById('repFilterCalendar')?.value || "";
        const fTerr = document.getElementById('terrFilterCalendar')?.value || "";
        const fRole = document.getElementById('roleFilterCalendar')?.value || "";
        const fStatus = document.getElementById('statusFilterCalendar')?.value || "";
        
        // Создаем список ТОЛЬКО из актуальных сотрудников (никаких данных из визитов)
        const repsMap = {};
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const rep = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                           emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (!rep) return;
                
                const role = emp["Роль"] || emp["роль"] || emp["Роль "] || "";
                const status = emp["Статус"] || emp["статус"] || emp["Статус "] || "";
                const empInfo = employeesMap[rep.toString().trim()];
                const territory = empInfo ? empInfo.territory : (emp["Область"] || emp["Область "] || emp["область"] || 
                           emp["Территория"] || emp["Территория "] || emp["территория"] || "Прочие");
                const group = empInfo ? empInfo.group : (emp["Группа"] || emp["Группа "] || emp["группа"] || "-");
                
                // Фильтруем по всем критериям
                if ((fRep && rep !== fRep) || (fTerr && territory !== fTerr)) return;
                if (fRole && role.toString().trim() !== fRole) return;
                if (fStatus && status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim()) return;
                
                if (rep && !repsMap[rep]) {
                    repsMap[rep] = { rep: rep, territory: territory, group: group };
                }
            });
        }
        
        // Фильтруем визиты только от актуальных МП
        const validRepsForCalendar = new Set();
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const name = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                            emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (name) validRepsForCalendar.add(name.toString().trim());
            });
        }
        const territoriesMap = {};
        Object.values(repsMap).forEach(repInfo => {
            const terr = repInfo.territory;
            if (!territoriesMap[terr]) territoriesMap[terr] = [];
            territoriesMap[terr].push(repInfo);
        });
        function getGroupSortOrder(group) {
            const g = (group || "").toLowerCase();
            if (g.includes("альфа")) return 1;
            if (g.includes("бета")) return 2;
            if (g.includes("гамма") || g.includes("gamma")) return 3;
            if (g.includes("дельта") || g.includes("delta")) return 4;
            return 999;
        }
        Object.keys(territoriesMap).forEach(terr => {
            territoriesMap[terr].sort((a, b) => {
                const orderA = getGroupSortOrder(a.group);
                const orderB = getGroupSortOrder(b.group);
                return orderA !== orderB ? orderA - orderB : a.rep.localeCompare(b.rep, 'ru');
            });
        });
        const allReps = [];
        Object.keys(territoriesMap).sort().forEach(terr => {
            territoriesMap[terr].forEach(repInfo => allReps.push(repInfo));
        });
        const visitsData = {};
        allReps.forEach(repInfo => {
            const rep = repInfo.rep;
            visitsData[rep] = {};
            let total = 0, filledDays = 0, emptyDays = 0;
            daysToShow.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dateKey = `${date.getDate()}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
                const visits = rawData.filter(row => {
                    const rowRep = row["Мед представитель"] || "";
                    // Фильтруем только визиты от актуальных МП
                    if (validRepsForCalendar.size > 0 && !validRepsForCalendar.has(rowRep.toString().trim())) return false;
                    
                    const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
                    return rowRep === rep && rowDate && (rowDate === dateStr || rowDate === dateKey || rowDate.startsWith(dateStr) || rowDate.includes(dateKey)) && (!fRep || rowRep === fRep) && (!fTerr || (row["Территория"] || "Прочие") === fTerr);
                });
                const count = visits.length;
                visitsData[rep][dateStr] = count;
                total += count;
                if (count > 0) filledDays++; else emptyDays++;
            });
            visitsData[rep].total = total;
            visitsData[rep].filledDays = filledDays;
            visitsData[rep].emptyDays = emptyDays;
            visitsData[rep].percentage = daysToShow.length > 0 ? Math.round((filledDays / daysToShow.length) * 100) : 0;
        });
        let html = '<div style="overflow-x: auto;"><table class="calendar-table"><thead><tr><th>МП</th>';
        daysToShow.forEach(date => {
            const dayName = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][date.getDay()];
            const dateStr = `${date.getDate()}.${String(date.getMonth() + 1).padStart(2, '0')}`;
            html += `<th>${dateStr}<br><small>${dayName}</small></th>`;
        });
        html += '<th class="stat-col">Зап</th><th class="stat-col">Пусто</th><th class="stat-col">%</th><th class="stat-col">Итого</th></tr></thead><tbody>';
        Object.keys(territoriesMap).sort().forEach(terr => {
            html += `<tr class="terr-row"><td colspan="${daysToShow.length + 5}">${terr}</td></tr>`;
            territoriesMap[terr].forEach(repInfo => {
                const rep = repInfo.rep;
                html += '<tr><td style="padding-left: 8px; text-align: left;">' + rep + '</td>';
                daysToShow.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const count = visitsData[rep][dateStr] || 0;
                    const className = count > 0 ? 'visit-count clickable' : 'visit-count zero';
                    const clickHandler = count > 0 ? `onclick="showVisitsDetails('${rep}', '${dateStr}')"` : '';
                    html += `<td style="text-align: right;" ${clickHandler}><span class="${className}">${count}</span></td>`;
                });
                const filledDays = visitsData[rep].filledDays || 0;
                const emptyDays = visitsData[rep].emptyDays || 0;
                const percentage = visitsData[rep].percentage || 0;
                let percentageClass = 'percentage';
                if (percentage >= 80) percentageClass += ' high';
                else if (percentage >= 50) percentageClass += ' medium';
                else percentageClass += ' low';
                html += `<td class="stat-col" style="text-align: right;">${filledDays}</td><td class="stat-col" style="text-align: right;">${emptyDays}</td><td class="stat-col ${percentageClass}" style="text-align: right;">${percentage}%</td><td class="month-total" style="text-align: right;">${visitsData[rep].total || 0}</td></tr>`;
            });
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
        const calendarMonthEl = document.getElementById('calendarMonth');
        const repFilterEl = document.getElementById('repFilterCalendar');
        const terrFilterEl = document.getElementById('terrFilterCalendar');
        const roleFilterEl = document.getElementById('roleFilterCalendar');
        const statusFilterEl = document.getElementById('statusFilterCalendar');
        if (calendarMonthEl) calendarMonthEl.addEventListener('change', renderCalendar);
        if (repFilterEl) repFilterEl.addEventListener('change', renderCalendar);
        if (terrFilterEl) terrFilterEl.addEventListener('change', renderCalendar);
        if (roleFilterEl) roleFilterEl.addEventListener('change', renderCalendar);
        if (statusFilterEl) statusFilterEl.addEventListener('change', renderCalendar);
    }

    function renderAnalytics() {
        const container = document.getElementById('analyticsContent');
        const monthInputEl = document.getElementById('analyticsMonth');
        if (!container) {
            console.error('renderAnalytics: container не найден');
            return;
        }
        if (!monthInputEl) {
            container.innerHTML = '<div class="empty">Ошибка: поле месяца не найдено</div>';
            return;
        }
        let monthInput = monthInputEl.value;
        if (!monthInput) {
            // Автоматически устанавливаем текущий месяц, если не выбран
            setCurrentMonthAnalytics();
            monthInput = monthInputEl.value;
            if (!monthInput) {
                container.innerHTML = '<div class="empty">Выберите месяц</div>';
                return;
            }
        }
        if (!rawData || rawData.length === 0) {
            container.innerHTML = '<div class="empty">Загрузите данные. Нажмите F5 для обновления страницы.</div>';
            return;
        }
        
        // Показываем загрузку
        container.innerHTML = '<div class="loading">Загрузка аналитики...</div>';
        // Создаем карту сотрудников из актуальных данных
        const employeesMap = {};
        const empMapData = (allEmployeesData && allEmployeesData.length > 0) ? allEmployeesData : 
                          (employeesData && employeesData.length > 0) ? employeesData : [];
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const repName = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                               emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (repName) {
                    employeesMap[repName.toString().trim()] = {
                        territory: emp["Область"] || emp["Область "] || emp["область"] || 
                                   emp["Территория"] || emp["Территория "] || emp["территория"] || "Прочие",
                        group: emp["Группа"] || emp["Группа "] || emp["группа"] || "-"
                    };
                }
            });
        }
        
        const fRep = document.getElementById('repFilterAnalytics')?.value || "";
        const fTerr = document.getElementById('terrFilterAnalytics')?.value || "";
        const fRole = document.getElementById('roleFilterAnalytics')?.value || "";
        const fStatus = document.getElementById('statusFilterAnalytics')?.value || "";
        const [year, month] = monthInput.split('-').map(Number);
        const monthStart = new Date(year, month - 1, 1);
        const monthEnd = new Date(year, month, 0);
        const threeMonthsAgo = new Date(year, month - 4, 1);
        const previousData = rawData.filter(row => {
            const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
            if (!rowDate) return false;
            let date = new Date(rowDate);
            if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
            return !isNaN(date.getTime()) && date >= threeMonthsAgo && date < monthStart;
        });
        // Создаем список актуальных МП для фильтрации
        const validRepsForAnalytics = new Set();
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const name = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                            emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (name) validRepsForAnalytics.add(name.toString().trim());
            });
        }
        
        const monthData = rawData.filter(row => {
            const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
            const rowRep = row["Мед представитель"] || "";
            
            // Фильтруем только визиты от актуальных МП
            if (validRepsForAnalytics.size > 0 && !validRepsForAnalytics.has(rowRep.toString().trim())) return false;
            
            const empInfo = employeesMap[rowRep.toString().trim()];
            const rowTerr = empInfo ? empInfo.territory : (row["Территория"] || "");
            if ((fRep && rowRep !== fRep) || (fTerr && rowTerr !== fTerr)) return false;
            if (!rowDate) return false;
            let date = new Date(rowDate);
            if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
            return !isNaN(date.getTime()) && date >= monthStart && date <= monthEnd;
        });
        
        // Создаем список ТОЛЬКО из актуальных сотрудников (никаких данных из визитов)
        const repsMap = {};
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const rep = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                           emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (!rep) return;
                
                const role = emp["Роль"] || emp["роль"] || emp["Роль "] || "";
                const status = emp["Статус"] || emp["статус"] || emp["Статус "] || "";
                const empInfo = employeesMap[rep.toString().trim()];
                const territory = empInfo ? empInfo.territory : (emp["Область"] || emp["Область "] || emp["область"] || 
                           emp["Территория"] || emp["Территория "] || emp["территория"] || "Прочие");
                const group = empInfo ? empInfo.group : (emp["Группа"] || emp["Группа "] || emp["группа"] || "-");
                
                // Проверяем все фильтры
                if ((fRep && rep !== fRep) || (fTerr && territory !== fTerr)) return;
                if (fRole && role.toString().trim() !== fRole) return;
                if (fStatus && status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim()) return;
                
                if (rep && !repsMap[rep]) {
                    repsMap[rep] = { 
                        rep: rep, 
                        territory: territory, 
                        group: group 
                    };
                }
            });
        }
        // Проверяем, есть ли сотрудники для отображения
        if (!repsMap || Object.keys(repsMap).length === 0) {
            container.innerHTML = '<div class="empty">Нет сотрудников для отображения. Проверьте фильтры или убедитесь, что данные загружены.</div>';
            return;
        }
        
        const territoriesMap = {};
        Object.values(repsMap).forEach(repInfo => {
            const terr = repInfo.territory;
            if (!territoriesMap[terr]) territoriesMap[terr] = [];
            territoriesMap[terr].push(repInfo);
        });
        function getGroupSortOrder(group) {
            const g = (group || "").toLowerCase();
            if (g.includes("альфа")) return 1;
            if (g.includes("бета")) return 2;
            if (g.includes("гамма") || g.includes("gamma")) return 3;
            if (g.includes("дельта") || g.includes("delta")) return 4;
            return 999;
        }
        Object.keys(territoriesMap).forEach(terr => {
            territoriesMap[terr].sort((a, b) => {
                const orderA = getGroupSortOrder(a.group);
                const orderB = getGroupSortOrder(b.group);
                return orderA !== orderB ? orderA - orderB : a.rep.localeCompare(b.rep, 'ru');
            });
        });
        const analyticsData = {};
        Object.values(repsMap).forEach(repInfo => {
            const rep = repInfo.rep;
            // Фильтруем визиты только для этого МП и только от актуальных МП
            let repVisits = monthData.filter(row => {
                const rowRep = row["Мед представитель"] || "";
                return rowRep === rep && validRepsForAnalytics.has(rowRep.toString().trim());
            });
            const daysWithVisits = new Set();
            
            repVisits.forEach(row => {
                const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
                if (rowDate) {
                    let date = new Date(rowDate);
                    if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
                    if (!isNaN(date.getTime())) daysWithVisits.add(date.toISOString().split('T')[0]);
                }
            });
            const avgVisitsPerDay = daysWithVisits.size > 0 ? Math.round(repVisits.length / daysWithVisits.size) : 0;
            const totalVisits = repVisits.length;
            const doctorVisitsCount = {};
            repVisits.forEach(row => {
                const doctor = row["Имя доктора"] || row["Врач"] || "";
                if (doctor) doctorVisitsCount[doctor] = (doctorVisitsCount[doctor] || 0) + 1;
            });
            const visitDistribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            Object.values(doctorVisitsCount).forEach(count => {
                if (count === 1) visitDistribution[1]++;
                else if (count === 2) visitDistribution[2]++;
                else if (count === 3) visitDistribution[3]++;
                else if (count === 4) visitDistribution[4]++;
                else if (count >= 5) visitDistribution[5]++;
            });
            const previousDoctors = new Set();
            previousData.filter(row => {
                const rowRep = row["Мед представитель"] || "";
                // Фильтруем только визиты от актуальных МП
                return rowRep === rep && validRepsForAnalytics.has(rowRep.toString().trim());
            }).forEach(row => {
                const doctor = row["Имя доктора"] || row["Врач"] || "";
                if (doctor) previousDoctors.add(doctor);
            });
            const currentDoctors = new Set(Object.keys(doctorVisitsCount));
            const newDoctors = Array.from(currentDoctors).filter(doc => !previousDoctors.has(doc));
            analyticsData[rep] = {
                rep: rep, territory: repInfo.territory, group: repInfo.group,
                avgVisitsPerDay: avgVisitsPerDay, totalVisits: totalVisits,
                visitDistribution: visitDistribution, newDoctorsCount: newDoctors.length,
                doctorVisitsCount: doctorVisitsCount, newDoctors: newDoctors, repVisits: repVisits
            };
        });
        // Проверяем, есть ли данные для отображения
        if (Object.keys(analyticsData).length === 0) {
            container.innerHTML = '<div class="empty">Нет данных для выбранного периода. Попробуйте выбрать другой месяц.</div>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr>';
        html += '<th>МП</th><th>Группа</th><th>Ср/день</th><th>Всего</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5+</th><th>Новых</th></tr></thead><tbody>';
        Object.keys(territoriesMap).sort().forEach(terr => {
            html += `<tr class="terr-row"><td colspan="10">${terr}</td></tr>`;
            territoriesMap[terr].forEach(repInfo => {
                const rep = repInfo.rep;
                const data = analyticsData[rep];
                if (!data) return;
                const repEncoded = encodeURIComponent(rep);
                html += '<tr><td style="padding-left: 8px; text-align: left;">' + escapeHtml(rep) + '</td>';
                html += '<td style="text-align: right;">' + escapeHtml(data.group) + '</td>';
                html += '<td style="text-align: right; font-weight: 600; color: var(--accent);">' + data.avgVisitsPerDay + '</td>';
                html += '<td style="text-align: right; font-weight: 600;">' + data.totalVisits + '</td>';
                [1, 2, 3, 4, 5].forEach(count => {
                    const num = data.visitDistribution[count];
                    const clickable = num > 0 ? `class="clickable-number" onclick="showDoctorsByVisitCount('${repEncoded}', ${count})"` : '';
                    html += `<td style="text-align: right;"><span ${clickable}>${num}</span></td>`;
                });
                const newDoctorsClickable = data.newDoctorsCount > 0 ? `class="clickable-number" onclick="showNewDoctors('${repEncoded}')"` : '';
                html += `<td style="text-align: right; font-weight: 600; color: ${data.newDoctorsCount > 0 ? 'var(--accent)' : '#666'};"><span ${newDoctorsClickable}>${data.newDoctorsCount}</span></td></tr>`;
            });
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        window.analyticsDataCache = analyticsData;
        
        // Удаляем старые обработчики и добавляем новые
        const analyticsMonthEl = document.getElementById('analyticsMonth');
        const repFilterAnalyticsEl = document.getElementById('repFilterAnalytics');
        const terrFilterAnalyticsEl = document.getElementById('terrFilterAnalytics');
        
        const roleFilterAnalyticsEl = document.getElementById('roleFilterAnalytics');
        const statusFilterAnalyticsEl = document.getElementById('statusFilterAnalytics');
        
        if (analyticsMonthEl) {
            analyticsMonthEl.removeEventListener('change', renderAnalytics);
            analyticsMonthEl.addEventListener('change', renderAnalytics);
        }
        if (repFilterAnalyticsEl) {
            repFilterAnalyticsEl.removeEventListener('change', renderAnalytics);
            repFilterAnalyticsEl.addEventListener('change', renderAnalytics);
        }
        if (terrFilterAnalyticsEl) {
            terrFilterAnalyticsEl.removeEventListener('change', renderAnalytics);
            terrFilterAnalyticsEl.addEventListener('change', renderAnalytics);
        }
        if (roleFilterAnalyticsEl) {
            roleFilterAnalyticsEl.removeEventListener('change', renderAnalytics);
            roleFilterAnalyticsEl.addEventListener('change', renderAnalytics);
        }
        if (statusFilterAnalyticsEl) {
            statusFilterAnalyticsEl.removeEventListener('change', renderAnalytics);
            statusFilterAnalyticsEl.addEventListener('change', renderAnalytics);
        }
    }

    function showVisitsDetails(rep, dateStr) {
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const date = new Date(dateStr + 'T00:00:00');
        const dateFormatted = date.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        modalTitle.textContent = `Визиты: ${rep} - ${dateFormatted}`;
        const dateKey = `${date.getDate()}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
        const visits = rawData.filter(row => {
            const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
            return row["Мед представитель"] === rep && rowDate && (rowDate === dateStr || rowDate === dateKey || rowDate.startsWith(dateStr) || rowDate.includes(dateKey));
        });
        if (visits.length === 0) {
            modalBody.innerHTML = '<div class="empty">Визиты не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        const visitsByLPU = {};
        visits.forEach(visit => {
            const lpu = visit["Аб ЛПУ"] || visit["ЛПУ"] || "—";
            if (!visitsByLPU[lpu]) visitsByLPU[lpu] = [];
            visitsByLPU[lpu].push(visit);
        });
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего визитов: ${visits.length}</strong></div>`;
        Object.keys(visitsByLPU).sort().forEach(lpu => {
            html += `<div style="margin-bottom: 15px;"><h3 style="color: var(--primary); margin-bottom: 8px; font-size: 14px;">${escapeHtml(lpu)}</h3>`;
            visitsByLPU[lpu].forEach(visit => {
                const doctor = visit["Имя доктора"] || visit["Врач"] || "—";
                const spec = visit["Специальность"] || visit["специальность"] || "—";
                html += `<div class="modal-visit-item"><div style="margin-bottom: 5px;"><strong>Врач:</strong> ${escapeHtml(doctor)} ${spec !== '—' ? `(${escapeHtml(spec)})` : ''}</div></div>`;
            });
            html += '</div>';
        });
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function showDoctorsByVisitCount(repEncoded, visitCount) {
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        if (!window.analyticsDataCache) { alert('Данные не загружены'); return; }
        const rep = decodeURIComponent(repEncoded);
        const data = window.analyticsDataCache[rep];
        if (!data) { alert('Данные не найдены'); return; }
        modalTitle.textContent = `Врачи: ${rep} - посещены ${visitCount} ${visitCount === 1 ? 'раз' : 'раза'}`;
        const doctorsWithCount = Object.entries(data.doctorVisitsCount).filter(([doctor, count]) => visitCount === 5 ? count >= 5 : count === visitCount).map(([doctor, count]) => ({ doctor, count }));
        if (doctorsWithCount.length === 0) {
            modalBody.innerHTML = '<div class="empty">Врачи не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        const visitsByDoctor = {};
        data.repVisits.forEach(row => {
            const doctor = row["Имя доктора"] || row["Врач"] || "";
            if (doctor && doctorsWithCount.find(d => d.doctor === doctor)) {
                if (!visitsByDoctor[doctor]) visitsByDoctor[doctor] = [];
                visitsByDoctor[doctor].push(row);
            }
        });
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего врачей: ${doctorsWithCount.length}</strong></div>`;
        Object.keys(visitsByDoctor).sort().forEach(doctor => {
            const visits = visitsByDoctor[doctor];
            const spec = visits[0]["Специальность"] || visits[0]["специальность"] || "—";
            const lpu = visits[0]["Аб ЛПУ"] || visits[0]["ЛПУ"] || "—";
            html += `<div class="modal-visit-item"><div style="margin-bottom: 6px;"><strong style="font-size: 14px; color: var(--primary);">${escapeHtml(doctor)}</strong> ${spec !== '—' ? `(${escapeHtml(spec)})` : ''} - ЛПУ: ${escapeHtml(lpu)}</div><div style="font-size: 12px; color: #666; margin-left: 16px;"><strong>Даты:</strong> `;
            const dates = visits.map(v => {
                const rowDate = v["Дата"] || v["Дата визита"] || v["Дата визита "] || "";
                if (!rowDate) return "";
                let date = new Date(rowDate);
                if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
                return !isNaN(date.getTime()) ? date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }) : rowDate;
            }).filter(Boolean).sort();
            html += dates.join(', ') + '</div></div>';
        });
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function showNewDoctors(repEncoded) {
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        if (!window.analyticsDataCache) { alert('Данные не загружены'); return; }
        const rep = decodeURIComponent(repEncoded);
        const data = window.analyticsDataCache[rep];
        if (!data) { alert('Данные не найдены'); return; }
        modalTitle.textContent = `Новые врачи: ${rep}`;
        if (data.newDoctors.length === 0) {
            modalBody.innerHTML = '<div class="empty">Новых врачей не найдено</div>';
            modal.style.display = 'block';
            return;
        }
        const visitsByDoctor = {};
        data.repVisits.forEach(row => {
            const doctor = row["Имя доктора"] || row["Врач"] || "";
            if (doctor && data.newDoctors.includes(doctor)) {
                if (!visitsByDoctor[doctor]) visitsByDoctor[doctor] = [];
                visitsByDoctor[doctor].push(row);
            }
        });
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего новых врачей: ${data.newDoctors.length}</strong></div>`;
        Object.keys(visitsByDoctor).sort().forEach(doctor => {
            const visits = visitsByDoctor[doctor];
            const spec = visits[0]["Специальность"] || visits[0]["специальность"] || "—";
            const lpu = visits[0]["Аб ЛПУ"] || visits[0]["ЛПУ"] || "—";
            html += `<div class="modal-visit-item"><div style="margin-bottom: 6px;"><strong style="font-size: 14px; color: var(--primary);">${escapeHtml(doctor)}</strong> ${spec !== '—' ? `(${escapeHtml(spec)})` : ''} - ЛПУ: ${escapeHtml(lpu)}</div><div style="font-size: 12px; color: #666; margin-left: 16px;"><strong>Даты:</strong> `;
            const dates = visits.map(v => {
                const rowDate = v["Дата"] || v["Дата визита"] || v["Дата визита "] || "";
                if (!rowDate) return "";
                let date = new Date(rowDate);
                if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
                return !isNaN(date.getTime()) ? date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }) : rowDate;
            }).filter(Boolean).sort();
            html += dates.join(', ') + '</div></div>';
        });
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function closeVisitsModal() {
        document.getElementById('visitsModal').style.display = 'none';
    }

    function escapeHtml(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function setCurrentMonthReports() {
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const monthValue = `${year}-${month}`;
        const reportsMonthEl = document.getElementById('reportsMonth');
        if (reportsMonthEl) reportsMonthEl.value = monthValue;
        renderReports();
    }

    function renderReports() {
        const container = document.getElementById('reportsContent');
        const monthInputEl = document.getElementById('reportsMonth');
        if (!container || !monthInputEl) return;
        const monthInput = monthInputEl.value;
        if (!monthInput || !rawData || rawData.length === 0) {
            container.innerHTML = '<div class="empty">Загрузите данные и выберите месяц</div>';
            return;
        }
        const fRep = document.getElementById('repFilterReports')?.value || "";
        const fTerr = document.getElementById('terrFilterReports')?.value || "";
        const fRole = document.getElementById('roleFilterReports')?.value || "";
        const fStatus = document.getElementById('statusFilterReports')?.value || "";
        const [year, month] = monthInput.split('-').map(Number);
        const monthStart = new Date(year, month - 1, 1);
        const monthEnd = new Date(year, month, 0);
        
        // Создаем список актуальных МП для фильтрации в отчетах
        const validRepsForReports = new Set();
        const reportsEmpData = (allEmployeesData && allEmployeesData.length > 0) ? allEmployeesData : 
                              (employeesData && employeesData.length > 0) ? employeesData : [];
        if (reportsEmpData.length > 0) {
            reportsEmpData.forEach(emp => {
                const name = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                            emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (name) validRepsForReports.add(name.toString().trim());
            });
        }
        
        // Создаем карту сотрудников с ролями и статусами для фильтрации
        const employeesRoleStatusMap = {};
        if (reportsEmpData.length > 0) {
            reportsEmpData.forEach(emp => {
                const rep = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                           emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (rep) {
                    employeesRoleStatusMap[rep.toString().trim()] = {
                        role: emp["Роль"] || emp["роль"] || emp["Роль "] || "",
                        status: emp["Статус"] || emp["статус"] || emp["Статус "] || ""
                    };
                }
            });
        }
        
        const monthData = rawData.filter(row => {
            const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
            const rowRep = row["Мед представитель"] || "";
            
            // Фильтруем только визиты от актуальных МП
            if (validRepsForReports.size > 0 && !validRepsForReports.has(rowRep.toString().trim())) return false;
            
            // Фильтруем по роли и статусу
            const empRoleStatus = employeesRoleStatusMap[rowRep.toString().trim()];
            if (fRole && (!empRoleStatus || empRoleStatus.role.toString().trim() !== fRole)) return false;
            if (fStatus && (!empRoleStatus || empRoleStatus.status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim())) return false;
            
            const rowTerr = row["Территория"] || "";
            if ((fRep && rowRep !== fRep) || (fTerr && rowTerr !== fTerr)) return false;
            if (!rowDate) return false;
            let date = new Date(rowDate);
            if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
            return !isNaN(date.getTime()) && date >= monthStart && date <= monthEnd;
        });

        // Подсчет визитов по АБ ЛПУ
        const lpuVisits = {};
        monthData.forEach(row => {
            const lpuAbbr = row["Аб ЛПУ"] || row["Аб лпу"] || row["АБ ЛПУ"] || row["ЛПУ"] || "—";
            const lpuFull = row["ЛПУ"] || row["Название ЛПУ"] || row["Лпу"] || lpuAbbr;
            const key = lpuAbbr !== "—" ? lpuAbbr : lpuFull;
            if (!lpuVisits[key]) {
                lpuVisits[key] = {
                    abbr: lpuAbbr !== "—" ? lpuAbbr : "",
                    full: lpuFull !== "—" ? lpuFull : key,
                    count: 0,
                    reps: new Set(),
                    doctors: new Set()
                };
            }
            lpuVisits[key].count++;
            if (row["Мед представитель"]) lpuVisits[key].reps.add(row["Мед представитель"]);
            if (row["Имя доктора"]) lpuVisits[key].doctors.add(row["Имя доктора"]);
        });

        // Подсчет визитов по специалистам
        const specialistVisits = {};
        monthData.forEach(row => {
            const spec = row["Специальность"] || row["Специальность врача"] || row["специальность"] || "—";
            const doctor = row["Имя доктора"] || row["Врач"] || "—";
            const key = spec !== "—" ? spec : "Без специальности";
            if (!specialistVisits[key]) {
                specialistVisits[key] = {
                    count: 0,
                    doctors: new Set(),
                    lpus: new Set(),
                    reps: new Set()
                };
            }
            specialistVisits[key].count++;
            if (doctor !== "—") specialistVisits[key].doctors.add(doctor);
            const lpuAbbr = row["Аб ЛПУ"] || row["Аб лпу"] || row["АБ ЛПУ"] || row["ЛПУ"] || "—";
            if (lpuAbbr !== "—") specialistVisits[key].lpus.add(lpuAbbr);
            if (row["Мед представитель"]) specialistVisits[key].reps.add(row["Мед представитель"]);
        });

        // Сохраняем данные для детализации
        reportsDataCache = { monthData, lpuVisits, specialistVisits };

        // Сортировка по количеству визитов (по убыванию)
        const sortedLPUs = Object.entries(lpuVisits)
            .sort((a, b) => b[1].count - a[1].count);
        const sortedSpecialists = Object.entries(specialistVisits)
            .sort((a, b) => b[1].count - a[1].count);

        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">';
        
        // Таблица по ЛПУ
        html += '<div><h2 style="font-size: 16px; color: var(--primary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--accent);">Охват МП по АБ ЛПУ</h2>';
        html += '<div style="overflow-x: auto;"><table><thead><tr><th>АБ ЛПУ</th><th>ЛПУ</th><th>Визитов</th><th>МП</th><th>Врачей</th></tr></thead><tbody>';
        
        sortedLPUs.forEach(([key, data]) => {
            const keyEncoded = encodeURIComponent(key);
            const visitsClickable = data.count > 0 ? `class="clickable-number" onclick="showLPUVisitsDetails('${keyEncoded}')"` : '';
            const repsClickable = data.reps.size > 0 ? `class="clickable-number" onclick="showLPUMPs('${keyEncoded}')"` : '';
            const doctorsClickable = data.doctors.size > 0 ? `class="clickable-number" onclick="showLPUDoctors('${keyEncoded}')"` : '';
            html += `<tr>
                <td style="text-align: left; font-weight: 600;">${escapeHtml(data.abbr || key)}</td>
                <td style="text-align: left;">${escapeHtml(data.full)}</td>
                <td style="text-align: right; font-weight: 600; color: var(--accent);"><span ${visitsClickable}>${data.count}</span></td>
                <td style="text-align: right;"><span ${repsClickable}>${data.reps.size}</span></td>
                <td style="text-align: right;"><span ${doctorsClickable}>${data.doctors.size}</span></td>
            </tr>`;
        });
        
        html += '</tbody></table></div></div>';
        
        // Таблица по специалистам
        html += '<div><h2 style="font-size: 16px; color: var(--primary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--accent);">Часто посещаемые специалисты</h2>';
        html += '<div style="overflow-x: auto;"><table><thead><tr><th>Специальность</th><th>Визитов</th><th>Врачей</th><th>ЛПУ</th><th>МП</th></tr></thead><tbody>';
        
        sortedSpecialists.forEach(([key, data]) => {
            const keyEncoded = encodeURIComponent(key);
            const visitsClickable = data.count > 0 ? `class="clickable-number" onclick="showSpecialistVisitsDetails('${keyEncoded}')"` : '';
            const doctorsClickable = data.doctors.size > 0 ? `class="clickable-number" onclick="showSpecialistDoctors('${keyEncoded}')"` : '';
            const lpusClickable = data.lpus.size > 0 ? `class="clickable-number" onclick="showSpecialistLPUs('${keyEncoded}')"` : '';
            const repsClickable = data.reps.size > 0 ? `class="clickable-number" onclick="showSpecialistMPs('${keyEncoded}')"` : '';
            html += `<tr>
                <td style="text-align: left; font-weight: 600;">${escapeHtml(key)}</td>
                <td style="text-align: right; font-weight: 600; color: var(--accent);"><span ${visitsClickable}>${data.count}</span></td>
                <td style="text-align: right;"><span ${doctorsClickable}>${data.doctors.size}</span></td>
                <td style="text-align: right;"><span ${lpusClickable}>${data.lpus.size}</span></td>
                <td style="text-align: right;"><span ${repsClickable}>${data.reps.size}</span></td>
            </tr>`;
        });
        
        html += '</tbody></table></div></div></div>';
        
        container.innerHTML = html;
        
        const reportsMonthEl = document.getElementById('reportsMonth');
        const repFilterReportsEl = document.getElementById('repFilterReports');
        const terrFilterReportsEl = document.getElementById('terrFilterReports');
        const roleFilterReportsEl = document.getElementById('roleFilterReports');
        const statusFilterReportsEl = document.getElementById('statusFilterReports');
        if (reportsMonthEl) reportsMonthEl.addEventListener('change', renderReports);
        if (repFilterReportsEl) repFilterReportsEl.addEventListener('change', renderReports);
        if (terrFilterReportsEl) terrFilterReportsEl.addEventListener('change', renderReports);
        if (roleFilterReportsEl) roleFilterReportsEl.addEventListener('change', renderReports);
        if (statusFilterReportsEl) statusFilterReportsEl.addEventListener('change', renderReports);
    }

    // Функции для детализации по ЛПУ
    function showLPUVisitsDetails(lpuKeyEncoded) {
        const lpuKey = decodeURIComponent(lpuKeyEncoded);
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const data = reportsDataCache.lpuVisits[lpuKey];
        if (!data) { alert('Данные не найдены'); return; }
        
        const lpuData = reportsDataCache.monthData.filter(row => {
            const lpuAbbr = row["Аб ЛПУ"] || row["Аб лпу"] || row["АБ ЛПУ"] || row["ЛПУ"] || "—";
            const lpuFull = row["ЛПУ"] || row["Название ЛПУ"] || row["Лпу"] || lpuAbbr;
            const key = lpuAbbr !== "—" ? lpuAbbr : lpuFull;
            return key === lpuKey;
        });
        
        modalTitle.textContent = `Визиты в ЛПУ: ${escapeHtml(data.abbr || lpuKey)} - ${escapeHtml(data.full)}`;
        
        if (lpuData.length === 0) {
            modalBody.innerHTML = '<div class="empty">Визиты не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего визитов: ${lpuData.length}</strong></div>`;
        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">МП</th><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">Врач</th><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">Дата</th></tr></thead><tbody>';
        
        lpuData.forEach(visit => {
            const rep = visit["Мед представитель"] || "—";
            const doctor = visit["Имя доктора"] || visit["Врач"] || "—";
            const spec = visit["Специальность"] || visit["специальность"] || "—";
            const rowDate = visit["Дата"] || visit["Дата визита"] || visit["Дата визита "] || "";
            let dateStr = rowDate;
            if (rowDate) {
                let date = new Date(rowDate);
                if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
                if (!isNaN(date.getTime())) dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
            }
            const doctorWithSpec = spec !== '—' ? `${escapeHtml(doctor)} (${escapeHtml(spec)})` : escapeHtml(doctor);
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(rep)}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${doctorWithSpec}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0; color: #666;">${escapeHtml(dateStr)}</td></tr>`;
        });
        
        html += '</tbody></table></div>';
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function showLPUMPs(lpuKeyEncoded) {
        const lpuKey = decodeURIComponent(lpuKeyEncoded);
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const data = reportsDataCache.lpuVisits[lpuKey];
        if (!data) { alert('Данные не найдены'); return; }
        
        modalTitle.textContent = `МП, посещавшие ЛПУ: ${escapeHtml(data.abbr || lpuKey)} - ${escapeHtml(data.full)}`;
        
        const repsList = Array.from(data.reps).sort();
        if (repsList.length === 0) {
            modalBody.innerHTML = '<div class="empty">МП не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего МП: ${repsList.length}</strong></div>`;
        repsList.forEach(rep => {
            const repVisits = reportsDataCache.monthData.filter(row => {
                const lpuAbbr = row["Аб ЛПУ"] || row["Аб лпу"] || row["АБ ЛПУ"] || row["ЛПУ"] || "—";
                const lpuFull = row["ЛПУ"] || row["Название ЛПУ"] || row["Лпу"] || lpuAbbr;
                const key = lpuAbbr !== "—" ? lpuAbbr : lpuFull;
                return key === lpuKey && row["Мед представитель"] === rep;
            });
            html += `<div class="modal-visit-item"><div style="margin-bottom: 5px;"><strong style="font-size: 14px; color: var(--primary);">${escapeHtml(rep)}</strong></div><div style="font-size: 12px; color: #666;">Визитов: ${repVisits.length}</div></div>`;
        });
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function showLPUDoctors(lpuKeyEncoded) {
        const lpuKey = decodeURIComponent(lpuKeyEncoded);
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const data = reportsDataCache.lpuVisits[lpuKey];
        if (!data) { alert('Данные не найдены'); return; }
        
        modalTitle.textContent = `Врачи в ЛПУ: ${escapeHtml(data.abbr || lpuKey)} - ${escapeHtml(data.full)}`;
        
        const doctorsList = Array.from(data.doctors).sort();
        if (doctorsList.length === 0) {
            modalBody.innerHTML = '<div class="empty">Врачи не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего врачей: ${doctorsList.length}</strong></div>`;
        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">Врач</th><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">Специальность</th><th style="padding: 8px; text-align: right; background: var(--primary); color: white;">Визитов</th></tr></thead><tbody>';
        
        doctorsList.forEach(doctor => {
            const doctorVisits = reportsDataCache.monthData.filter(row => {
                const lpuAbbr = row["Аб ЛПУ"] || row["Аб лпу"] || row["АБ ЛПУ"] || row["ЛПУ"] || "—";
                const lpuFull = row["ЛПУ"] || row["Название ЛПУ"] || row["Лпу"] || lpuAbbr;
                const key = lpuAbbr !== "—" ? lpuAbbr : lpuFull;
                return key === lpuKey && (row["Имя доктора"] || row["Врач"]) === doctor;
            });
            const spec = doctorVisits[0]?.["Специальность"] || doctorVisits[0]?.["специальность"] || "—";
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(doctor)}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${spec !== '—' ? escapeHtml(spec) : '—'}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">${doctorVisits.length}</td></tr>`;
        });
        
        html += '</tbody></table></div>';
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    // Функции для детализации по специалистам
    function showSpecialistVisitsDetails(specKeyEncoded) {
        const specKey = decodeURIComponent(specKeyEncoded);
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const data = reportsDataCache.specialistVisits[specKey];
        if (!data) { alert('Данные не найдены'); return; }
        
        modalTitle.textContent = `Визиты к специалистам: ${escapeHtml(specKey)}`;
        
        const specData = reportsDataCache.monthData.filter(row => {
            const spec = row["Специальность"] || row["Специальность врача"] || row["специальность"] || "—";
            const key = spec !== "—" ? spec : "Без специальности";
            return key === specKey;
        });
        
        if (specData.length === 0) {
            modalBody.innerHTML = '<div class="empty">Визиты не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего визитов: ${specData.length}</strong></div>`;
        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">МП</th><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">Врач</th><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">ЛПУ</th><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">Дата</th></tr></thead><tbody>';
        
        specData.forEach(visit => {
            const rep = visit["Мед представитель"] || "—";
            const doctor = visit["Имя доктора"] || visit["Врач"] || "—";
            const lpu = visit["Аб ЛПУ"] || visit["ЛПУ"] || "—";
            const rowDate = visit["Дата"] || visit["Дата визита"] || visit["Дата визита "] || "";
            let dateStr = rowDate;
            if (rowDate) {
                let date = new Date(rowDate);
                if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
                if (!isNaN(date.getTime())) dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
            }
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(rep)}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(doctor)}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(lpu)}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0; color: #666;">${escapeHtml(dateStr)}</td></tr>`;
        });
        
        html += '</tbody></table></div>';
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function showSpecialistDoctors(specKeyEncoded) {
        const specKey = decodeURIComponent(specKeyEncoded);
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const data = reportsDataCache.specialistVisits[specKey];
        if (!data) { alert('Данные не найдены'); return; }
        
        modalTitle.textContent = `Врачи-специалисты: ${escapeHtml(specKey)}`;
        
        const doctorsList = Array.from(data.doctors).sort();
        if (doctorsList.length === 0) {
            modalBody.innerHTML = '<div class="empty">Врачи не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего врачей: ${doctorsList.length}</strong></div>`;
        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">Врач</th><th style="padding: 8px; text-align: left; background: var(--primary); color: white;">ЛПУ</th><th style="padding: 8px; text-align: right; background: var(--primary); color: white;">Визитов</th></tr></thead><tbody>';
        
        doctorsList.forEach(doctor => {
            const doctorVisits = reportsDataCache.monthData.filter(row => {
                const spec = row["Специальность"] || row["Специальность врача"] || row["специальность"] || "—";
                const key = spec !== "—" ? spec : "Без специальности";
                return key === specKey && (row["Имя доктора"] || row["Врач"]) === doctor;
            });
            const lpu = doctorVisits[0]?.["Аб ЛПУ"] || doctorVisits[0]?.["ЛПУ"] || "—";
            html += `<tr><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(doctor)}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0;">${escapeHtml(lpu)}</td><td style="padding: 8px; border-bottom: 1px solid #e0e0e0; text-align: right;">${doctorVisits.length}</td></tr>`;
        });
        
        html += '</tbody></table></div>';
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function showSpecialistLPUs(specKeyEncoded) {
        const specKey = decodeURIComponent(specKeyEncoded);
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const data = reportsDataCache.specialistVisits[specKey];
        if (!data) { alert('Данные не найдены'); return; }
        
        modalTitle.textContent = `ЛПУ со специалистами: ${escapeHtml(specKey)}`;
        
        const lpusList = Array.from(data.lpus).sort();
        if (lpusList.length === 0) {
            modalBody.innerHTML = '<div class="empty">ЛПУ не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего ЛПУ: ${lpusList.length}</strong></div>`;
        lpusList.forEach(lpu => {
            const lpuVisits = reportsDataCache.monthData.filter(row => {
                const spec = row["Специальность"] || row["Специальность врача"] || row["специальность"] || "—";
                const key = spec !== "—" ? spec : "Без специальности";
                const rowLpu = row["Аб ЛПУ"] || row["Аб лпу"] || row["АБ ЛПУ"] || row["ЛПУ"] || "—";
                return key === specKey && rowLpu === lpu;
            });
            html += `<div class="modal-visit-item"><div style="margin-bottom: 5px;"><strong style="font-size: 14px; color: var(--primary);">${escapeHtml(lpu)}</strong></div><div style="font-size: 12px; color: #666;">Визитов: ${lpuVisits.length}</div></div>`;
        });
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function showSpecialistMPs(specKeyEncoded) {
        const specKey = decodeURIComponent(specKeyEncoded);
        const modal = document.getElementById('visitsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const data = reportsDataCache.specialistVisits[specKey];
        if (!data) { alert('Данные не найдены'); return; }
        
        modalTitle.textContent = `МП, посещавшие специалистов: ${escapeHtml(specKey)}`;
        
        const repsList = Array.from(data.reps).sort();
        if (repsList.length === 0) {
            modalBody.innerHTML = '<div class="empty">МП не найдены</div>';
            modal.style.display = 'block';
            return;
        }
        
        let html = `<div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;"><strong>Всего МП: ${repsList.length}</strong></div>`;
        repsList.forEach(rep => {
            const repVisits = reportsDataCache.monthData.filter(row => {
                const spec = row["Специальность"] || row["Специальность врача"] || row["специальность"] || "—";
                const key = spec !== "—" ? spec : "Без специальности";
                return key === specKey && row["Мед представитель"] === rep;
            });
            html += `<div class="modal-visit-item"><div style="margin-bottom: 5px;"><strong style="font-size: 14px; color: var(--primary);">${escapeHtml(rep)}</strong></div><div style="font-size: 12px; color: #666;">Визитов: ${repVisits.length}</div></div>`;
        });
        modalBody.innerHTML = html;
        modal.style.display = 'block';
    }

    function setCurrentMonthPlanFact() {
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const monthValue = `${year}-${month}`;
        const planfactMonthEl = document.getElementById('planfactMonth');
        if (planfactMonthEl) planfactMonthEl.value = monthValue;
        renderPlanFact();
    }

    function renderPlanFact() {
        const container = document.getElementById('planfactContent');
        const monthInputEl = document.getElementById('planfactMonth');
        if (!container || !monthInputEl) return;
        const monthInput = monthInputEl.value;
        if (!monthInput) {
            container.innerHTML = '<div class="empty">Выберите месяц</div>';
            return;
        }
        if (!rawData || rawData.length === 0) {
            container.innerHTML = '<div class="empty">Загрузите данные</div>';
            return;
        }
        
        const PLAN_VISITS_PER_MONTH = 288; // План визитов в месяц
        const PLAN_VISITS_PER_DAY = 12; // План визитов в день (~288/24 рабочих дня)
        
        const fRep = document.getElementById('repFilterPlanFact')?.value || "";
        const fTerr = document.getElementById('terrFilterPlanFact')?.value || "";
        const fRole = document.getElementById('roleFilterPlanFact')?.value || "";
        const fStatus = document.getElementById('statusFilterPlanFact')?.value || "";
        const [year, month] = monthInput.split('-').map(Number);
        const monthStart = new Date(year, month - 1, 1);
        const monthEnd = new Date(year, month, 0);
        
        // Создаем карту сотрудников из актуальных данных
        const employeesMap = {};
        const empMapData = (allEmployeesData && allEmployeesData.length > 0) ? allEmployeesData : 
                          (employeesData && employeesData.length > 0) ? employeesData : [];
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const repName = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                               emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (repName) {
                    employeesMap[repName.toString().trim()] = {
                        territory: emp["Область"] || emp["Область "] || emp["область"] || 
                                   emp["Территория"] || emp["Территория "] || emp["территория"] || "Прочие",
                        group: emp["Группа"] || emp["Группа "] || emp["группа"] || "-",
                        role: emp["Роль"] || emp["роль"] || emp["Роль "] || "",
                        status: emp["Статус"] || emp["статус"] || emp["Статус "] || ""
                    };
                }
            });
        }
        
        // Фильтруем визиты за месяц
        const monthData = rawData.filter(row => {
            const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
            const rowRep = row["Мед представитель"] || "";
            
            if (!rowDate) return false;
            let date = new Date(rowDate);
            if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
            if (isNaN(date.getTime())) return false;
            
            if (date < monthStart || date > monthEnd) return false;
            
            // Фильтруем по актуальным МП
            const empInfo = employeesMap[rowRep.toString().trim()];
            if (!empInfo) return false;
            
            // Фильтруем по выбранным фильтрам
            if (fRep && rowRep !== fRep) return false;
            if (fTerr && empInfo.territory !== fTerr) return false;
            if (fRole && empInfo.role.toString().trim() !== fRole) return false;
            if (fStatus && empInfo.status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim()) return false;
            
            return true;
        });
        
        // Создаем список сотрудников для отображения
        const repsMap = {};
        if (empMapData.length > 0) {
            empMapData.forEach(emp => {
                const rep = emp["МП"] || emp["МП "] || emp["мед представитель"] || emp["Мед представитель"] || 
                           emp["Мед. представитель"] || emp["Медицинский представитель"] || "";
                if (!rep) return;
                
                const empInfo = employeesMap[rep.toString().trim()];
                if (!empInfo) return;
                
                // Фильтруем по выбранным фильтрам
                if (fRep && rep !== fRep) return;
                if (fTerr && empInfo.territory !== fTerr) return;
                if (fRole && empInfo.role.toString().trim() !== fRole) return;
                if (fStatus && empInfo.status.toString().toLowerCase().trim() !== fStatus.toString().toLowerCase().trim()) return;
                
                if (rep && !repsMap[rep]) {
                    repsMap[rep] = {
                        rep: rep,
                        territory: empInfo.territory,
                        group: empInfo.group
                    };
                }
            });
        }
        
        // Подсчитываем факт для каждого МП
        const planFactData = {};
        Object.values(repsMap).forEach(repInfo => {
            const rep = repInfo.rep;
            const repVisits = monthData.filter(row => {
                const rowRep = row["Мед представитель"] || "";
                return rowRep === rep;
            });
            
            // Подсчитываем рабочие дни (исключаем выходные)
            const allDays = [];
            for (let day = 1; day <= monthEnd.getDate(); day++) {
                const date = new Date(year, month - 1, day);
                allDays.push(date);
            }
            
            // Подсчитываем дни с визитами
            const daysWithVisits = new Set();
            repVisits.forEach(row => {
                const rowDate = row["Дата"] || row["Дата визита"] || row["Дата визита "] || "";
                if (rowDate) {
                    let date = new Date(rowDate);
                    if (isNaN(date.getTime())) date = new Date(rowDate.replace(/\./g, '/'));
                    if (!isNaN(date.getTime())) {
                        daysWithVisits.add(date.toISOString().split('T')[0]);
                    }
                }
            });
            
            const factVisits = repVisits.length;
            const factDays = daysWithVisits.size;
            const avgPerDay = factDays > 0 ? Math.round(factVisits / factDays * 10) / 10 : 0;
            const planCompletion = Math.round((factVisits / PLAN_VISITS_PER_MONTH) * 100);
            const deviation = factVisits - PLAN_VISITS_PER_MONTH;
            
            planFactData[rep] = {
                rep: rep,
                territory: repInfo.territory,
                group: repInfo.group,
                plan: PLAN_VISITS_PER_MONTH,
                fact: factVisits,
                deviation: deviation,
                planCompletion: planCompletion,
                avgPerDay: avgPerDay,
                factDays: factDays,
                planDays: 24 // Примерно 24 рабочих дня в месяце
            };
        });
        
        // Группируем по территориям
        const territoriesMap = {};
        Object.values(repsMap).forEach(repInfo => {
            const terr = repInfo.territory;
            if (!territoriesMap[terr]) territoriesMap[terr] = [];
            territoriesMap[terr].push(repInfo);
        });
        
        // Сортируем по группам
        function getGroupSortOrder(group) {
            const g = (group || "").toLowerCase();
            if (g.includes("альфа")) return 1;
            if (g.includes("бета")) return 2;
            if (g.includes("гамма") || g.includes("gamma")) return 3;
            if (g.includes("дельта") || g.includes("delta")) return 4;
            return 999;
        }
        
        Object.keys(territoriesMap).forEach(terr => {
            territoriesMap[terr].sort((a, b) => {
                const orderA = getGroupSortOrder(a.group);
                const orderB = getGroupSortOrder(b.group);
                return orderA !== orderB ? orderA - orderB : a.rep.localeCompare(b.rep, 'ru');
            });
        });
        
        // Рендерим таблицу
        let html = '<div style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">';
        html += `<strong>План на месяц:</strong> ${PLAN_VISITS_PER_MONTH} визитов | <strong>План в день:</strong> ~${PLAN_VISITS_PER_DAY} визитов`;
        html += '</div>';
        html += '<div style="overflow-x: auto;"><table><thead><tr>';
        html += '<th>МП</th><th>Группа</th><th>План</th><th>Факт</th><th>Отклонение</th><th>% выполнения</th><th>Ср/день</th><th>Дней с визитами</th></tr></thead><tbody>';
        
        Object.keys(territoriesMap).sort().forEach(terr => {
            html += `<tr class="terr-row"><td colspan="8">${escapeHtml(terr)}</td></tr>`;
            territoriesMap[terr].forEach(repInfo => {
                const rep = repInfo.rep;
                const data = planFactData[rep];
                if (!data) return;
                
                const deviationColor = data.deviation >= 0 ? '#2ecc71' : '#DF3B20';
                const completionColor = data.planCompletion >= 100 ? '#2ecc71' : (data.planCompletion >= 80 ? '#f39c12' : '#DF3B20');
                const avgColor = data.avgPerDay >= PLAN_VISITS_PER_DAY ? '#2ecc71' : (data.avgPerDay >= PLAN_VISITS_PER_DAY * 0.8 ? '#f39c12' : '#DF3B20');
                
                html += `<tr>
                    <td style="text-align: left; padding-left: 8px;">${escapeHtml(data.rep)}</td>
                    <td style="text-align: right;">${escapeHtml(data.group)}</td>
                    <td style="text-align: right; font-weight: 600;">${data.plan}</td>
                    <td style="text-align: right; font-weight: 600; color: var(--accent);">${data.fact}</td>
                    <td style="text-align: right; font-weight: 600; color: ${deviationColor};">${data.deviation >= 0 ? '+' : ''}${data.deviation}</td>
                    <td style="text-align: right; font-weight: 600; color: ${completionColor};">${data.planCompletion}%</td>
                    <td style="text-align: right; font-weight: 600; color: ${avgColor};">${data.avgPerDay}</td>
                    <td style="text-align: right;">${data.factDays}</td>
                </tr>`;
            });
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
        // Добавляем обработчики событий
        const planfactMonthEl = document.getElementById('planfactMonth');
        const repFilterPlanFactEl = document.getElementById('repFilterPlanFact');
        const terrFilterPlanFactEl = document.getElementById('terrFilterPlanFact');
        const roleFilterPlanFactEl = document.getElementById('roleFilterPlanFact');
        const statusFilterPlanFactEl = document.getElementById('statusFilterPlanFact');
        if (planfactMonthEl) planfactMonthEl.addEventListener('change', renderPlanFact);
        if (repFilterPlanFactEl) repFilterPlanFactEl.addEventListener('change', renderPlanFact);
        if (terrFilterPlanFactEl) terrFilterPlanFactEl.addEventListener('change', renderPlanFact);
        if (roleFilterPlanFactEl) roleFilterPlanFactEl.addEventListener('change', renderPlanFact);
        if (statusFilterPlanFactEl) statusFilterPlanFactEl.addEventListener('change', renderPlanFact);
    }

    fetchData();
</script>

</body>
</html>
